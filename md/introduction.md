# イントロダクション
本ドキュメントは、 C++でのプログラミング、 デザイン、
ソフトウェア開発におけるプロセス、ワークフロー等に対する原理、原則をまとめたものである。

ソフトウェア工学を実践的に学習した者には明らかなように、
ソフトウェア工学はトレードオフを扱う学問である。
従って、後述する、しないにかかわらずソフトウェアの原理、原則は、
常にそれが正しいとは限らず、またそれらが互いに矛盾することもある。
老子の至言「道の道とすべきは、常の道に非ず」のごときものである。

ソフトウェア開発の現場においては、このことを常に念頭に置き、
慎重且つ深い洞察を以って、これらを実践すべきである。

## 本ドキュメントの目的
「守破離」とは、日本の伝統武道、技芸の修行者が歩むべき習熟モデルである。
「守」、「破」、「離」それぞれが以下のような修行者の習熟レベルと、それに基づいた行動規範を表す。

* 「守」- 未熟な修行者であり、まずは、先人の残した「形(型)」を無批判に受け入れ、それを反復すること
* 「破」-「形」に習熟した修行者であり、「形」に自らの工夫を加えながら、より高いレベルを探求すること
* 「離」- 最高レベルに到達した修行者であり、自らが「形」を作り出すこと

このドキュメントは、

* 「守」のレベルにあるC++プログラマに「形」を提供すること
* そのようなプログラマの「破」への道しるべとなること
* このドキュメントを批判的に読むことで、「破」のプログラマに「離」への切っ掛けを与えること
* C++で開発を行うチームが作り出すソースコードに規律や整合性を与えること、
  もしくは守るべき規範のボトムラインを示すこと

を目的とする。

## 本ドキュメントの次に
本ドキュメントを読み、理解したプログラマの次のステップのために、
巻末に「[参考文献](---)」を設けた。

それらを読破し、合理的理由でこれらに倣い、もしくは批判できるようになることで、
「守」が終了し、「破」へと進むことができると考えられる。

## 改訂履歴
* V17.07
    * ソフトウェアプラクティスに加筆

* V17.06
    * 用語の統一、タイポの修正
    * usingディレクティブのルールを緩和
    * 特殊関数の宣言の説明のテーブルを修正

* V17.05
    * Strategyの使用例を追加
    * Factoryの使用例を追加
    * オブジェクトの所有権に「オブジェクトの排他所有」と「オブジェクトの共有所有」を追加

* V17.04
    * inline namespaceの使用を緩和
    * プリプロセッサ命令の使用を緩和
    * ラムダ式によるオブジェクトの初期化を追加
    * Pimpl/DIの使用例を追加

* V17.03
    * g++/clang++バージョンアップ
    * WSL -> WSL2
    * Ubuntu 18 -> Ubuntu 22

* V17.02
    * googletest-release-1.11.0  -> googletest-release-1.12.1
    * googletest-release-1.11.0/ -> googletest/
    * リポジトリ再構築
    * キーワードのリンク張り

* V17.01
    * visitorパターンのクラス図を詳細に表現
    * observerパターンのファイルの依存関係の修正
    * copy代入演算子、move代入演算子のルール追加
    * 仮想関数の宣言に使用するoverride、finalのルール変更
    * = deleteしたオーバーロードの例を強化
    * using宣言/usingディレクティブの制限強化
    * AAAスタイル(almost always auto)の説明の追加と採用
    * doxygenのコメントスタイルを変更

* V17.00
    * C++17に対応
        * ルールや解説追加
            * = {}を使用した初期化の型推論に対する規制追加
            * std::experimental::filesystem -> std::filesystem
            * 戻り値のルール追加
            * 畳みこみ式の解説
            * constexpr ifの解説
            * 自動変数のルール追加(if文とswitch文の条件式と初期化の分離)
            * constexprラムダ式に関するルール追加
            * [[fallthrough]]属性のルール追加
        * リファクタリング
            * クラステンプレートのテンプレート引数推論の使用
            * 構造化束縛の使用
            * std::pair<bool, T> -> std::optional
            * 関数の引数型std::string const& -> std::string or std::string_view
            * staticなメンバ変数初期化をクラス内部で行うため、inlineを使用
            * std::byteの使用
            * T::value -> T_v
            * T::type -> T_t
            * static_assert(COND, "") -> static_assert(COND)
            * [[nodiscard]]属性の使用

    * エクセプションを発生させいない関数にnoexceptを付加
    * テンプレートの命名規則を追加し、それに合わせてテンプレート識別子変更
    * コードクローンの削除
    * 「一様初期化(uniform initialization)」の規制変更

* V08.XX
    * ファイル位置を静的に保持したエクセプションクラスの基底クラスを指定できるように変更
    * ダイナミックメモリアロケーションでメモリ不足等の通知用エクセプションオブジェクトを変更
    * リファクタリング
        * example/ref_async_rN
        * example/deps
        * exercise/solid_[aq]
        * exercise/programming_convention_[aq]
    * new T -> std::make_unique\<T>()に変更
    * Immutableパターンのリンクの追加
    * cppcheckの使い方追加
    * noexceptのルールを追加
    * コンパイラのバージョンアップ
        * g++ 9.3 -> 10.3
        * clang++ 10.0 -> 12.0
    * 「デバッグ」に現象を追加
    * Pimplの例にコードを追加
    * ファイル属性の見直し
    * cygwinでもexampleがビルドできるようにした。
    * make formatの修正
    * pngファイル再生成
    * vim_configをアップデート
    * Nstd::Seq -> index_sequenceとし、utilityのものを使用するようにした。
    * 「enumによるビットマスク表現」をC++の正式名称である「BitmaskType」に変更
    * 「一様初期化(uniform initialization)」を積極的に使うように変更
    * 「多重継承」のルールを緩和
    * 「テンプレートメタプログラミング」に「静的な文字列オブジェクト」を追加
    * clang++のコードカバレッジ出力サポート
    * googletest-release-1.10.0 -> googletest-release-1.11.0
    * md_gem
        * 外部のリポジトリに移動
        * 新規機能に合わせた修正
        * md_genがない場合でも、exercise/build.shが使えるようにした。
    * 細かなバグ修正

* V07.XX
    * 「デザインパターン」に下記を追加
        * Cでのクラス表現
        * CRTP(curiously recurring template pattern)
    * 「アーキテクチャ」の章を追加
    * 「デバッグ」中にあった「deps」を単独の章に移動
    * 「開発プロセスとインフラ」のまとめの修正
    * exerciseの章立ての見直しとリンク追加
    * const T -> T const
    * 「用語解説」の追加
        * 「シンタックス、セマンティクス」に説明を追加
        * 「RTTI」に説明を追加
        * 「リファレンスcollapsing」を追加
        * 用語を階層化
    * ドキュメント生成
        * xxx/build.shの見直し
        * ソースコードのフォーマット用スクリプト追加

* V06.00
    * 「ダイナミックメモリアロケーション」の章を追加

* V05.XX
    * 章、節等の修正、追加
        * 「テンプレートメタプログラミング」章を追加
        * exerciseにテンプレートメタプログラミングの章を追加
        * 静的ポリモーフィズムよるTemplateメソッドの例を追加

* V04.XX
    * 「プログラミング規約」の変更、追加
        * 名前空間のルールを追加
        * 特殊メンバ関数のルール変更
    * 「デバッグ」章を追加
    * 「用語解説」の変更、追加
        * glvalueの説明追加
    * その他
        * example/配下のコードの整理・整頓
        * tools/export_exercise.shのバグフィックス

* V03.XX
    * 「プログラミング規約」の変更、追加
        * エクセプション処理ルールを追加
        * newに対するルールを追加
        * 名前空間のルールを追加
        * 「一様初期化」のルールを変更
    * 「用語解説」の変更、追加
        * RVO/SSO等の用語解説を追加
        * 「スライシング」の説明とルールの場所変更
    * 章、節等の修正、追加
        * 「開発ルール」、「vimの設定」の追加
        * exerciseにSOLIDの章を追加
    * サンプルコードの修正、追加
        * stringstream -> ostringstream
        * cygwinで動作しないUTをcygwin上ではDISABLEDに
        * spin lockの例を追加 
    * その他
        * ./tools/export_exercise.shでエクスポートするファイルが足りていない問題の対処
        * gitコミット漏れの修正

* V02.XX
    * 章、節等の修正、追加
        * SOLIDを単体の章にして、デザインパターンの前に移動
        * exerciseの問題にタイトルを付加
        * exerciseのデザインパターン(実践)に演習追加
        * 「using宣言/usingディレクティブ」、 「実引数依存探索(ADL)」追加
        * 「How to make this document」にexerciseのコードの説明追加
        * 改訂履歴をイントロダクションに掲載
        * 「セマンティクス」、「オーバーライドとオーバーロードの違い」等の解説追加
        * rvalue、コンパイラ自動生成関数の定義等を「プログラミング規約」から移動
        * rvalue、スライシング、オブジェクトの所有権に図を追加して、説明を強化
    * サンプルコードの修正、追加
        * リリース用ツールのリファクタリング
        * 「並行処理」のプログラムのバグ修正
        * リリース前テスト用exercise/build.sh、sample/build.shを追加
    * ドキュメント生成
        * ./tools/build.shにpdf化で右端がカットされてしまう画像の検出機能追加
        * ./tools/git_ci_release.shでgit tagの付加
        * 参照->リファレンス、例外->エクセプション等の用語の使い方の見直し

* V01.XX
    * 章、節等の修正、追加
        * 「推定有罪」の追加
        * 「命名規則」の章立てを大幅に見直し
        * 「並行処理」を追加
        * 「struct」の規則の追加
        * 「汎整数型」を追加
        * 「コード解析」を追加
        * 「Named Constructor」を追加
        * 「凝集度」の説明を追加
        * 「 配列」を追加
        * 「開発プロセスとインフラのまとめ」を追加
        * 「演習」と「解答」を追加
    * サンプルコードの修正、追加
        * sanitizerやscan-buildでテストを容易に
        * 単体テストで使用するアサーションをEXPECT_XXXからASSERT_XXXに
        * 「オーバーライド」のサンプルコードを追加
        * 「constexpr関数」にサンプルコードを追加
    * ドキュメント生成
        * 各章の番号廃止
        * ドキュメント生成用のbuild.sh追加
        * shellスクリプト類を./tools/に移動
        * ドキュメント生成ツールをrubyからpython3に変更

## 本ドキュメントの修正・改善
本ドキュメントをソフトウェア開発のルールとして採用したチームのプログラマにとって、
本ドキュメントは守るべき「形」であるが、「形」であることは不変であることを意味しない。
むしろ、ソフトウェア工学の進歩やチームの習熟に合わせ、その時点で最も正しいであろうルール、
プラクティスを積極的に導入することで、「形」の陳腐化を防ぐべきである。
このことは、スコット・メイヤーズ氏によるEffective C++の第1版から第3版、
およびEffective Modern C++までの変遷を読むことで、より深い理解が得られるはずである。
従って、「破」や「離」のレベルにあるプログラマは、
このドキュメントや、このドキュメントから派生した(もしくは、それとは無関係な)
チームのルールの内容を定期的に見直し、より高いレベルへと改善させるよう努めてほしい。

## 例示したコードの説明
次章以降では、ソースコードを使って説明を行う場合がある。このような場合の注意点を述べる。

* 「...」のみで構成された行は、ソースコードの省略を表す。
* 特定の規則、法則、慣習等を説明するためのソースコードは、シンプルさを優先するため、
  その他の規則、法則、慣習に従っていない場合がある。特に識別子に関しては、
  「[命名規則](---)」に従っていない場合が多い。
  また、一般にSTLのコンテナクラスやstd::stringをnewする必要はないが、
  コードの動作を示すためにあえてそのようにする場合がある。
* ソースコード内に動作説明のような本来不要なコメントがあるのは、
  読者にその意味を知らせるためであるため、製品コードのコメントをこのようにするべきではない。
* 例示したコードの動作の確認、明示のために
  [google test(gtest)](http://opencv.jp/googletestdocs/primer.html)のアサーション(下表)を使用する。

|アサーションマクロ  | 意味                                     |
|:-------------------|:-----------------------------------------|
| ASSERT_TRUE(x)     | xがtrue                                  |
| ASSERT_FALSE(x)    | xがfalse                                 |
| ASSERT_EQ(x, y)    | (x == y)がtrue                           |
| ASSERT_NE(x, y)    | (x != y)がtrue                           |
| ASSERT_GE(x, y)    | (x >= y)がtrue                           |
| ASSERT_GT(x, y)    | (x >  y)がtrue                           |
| ASSERT_LE(x, y)    | (x <= y)がtrue                           |
| ASSERT_LT(x, y)    | (x <  y)がtrue                           |
| ASSERT_STREQ(x, y) | (std::string(x) == std::string(y))がtrue |
| ASSERT_DEATH(x, y) | xを実行するとアボートすればtrue          |
| ASSERT_THROW(x, y) | xを実行するとy例外が発生すればtrue       |

* 問題を示すために掲載したコードは、実行すると不具合を発生させることがある。
  そういった場合、下記のように単体テストのラベルにDISABLED\_を付けることで、
  その実行を抑止することがある。

```cpp
    TEST(DISABLED_Xxx, yyy)
    {
        // 単体テスト
    }
```

## 本ドキュメントでの言葉の使い方の注意
* 参照
    * 「～を参照する」というような文脈で使われる**「参照」**はそのまま使用する。
    * C++での参照型を表す**参照**は使わず、代わりに**「リファレンス」**を使用する。
* 例外
    * 「～の場合は例外である」というような文脈で使われる**「例外」**はそのまま使用する。
    * C++でthrowすると発生する事象を表す**例外**は使わず、代わりに**「エクセプション」**を使用する。
* classとクラス
    * **class**はC++のキーワードとして使用する。
    * **クラス**は上記以外で使用する。
* プログラミングとコーディング、ソースコードとコード、インスタンスとオブジェクト
    * 同じような意味で使用する。


